#!/bin/bash -x
# initialization specific to Trimslice hardware

# for debugging we need to identify use of uninitialized variables
set -u

FEDORA=`rpm -q fedora-release|gawk 'BEGIN {FS="-";}{print $3}'`
XSARCH=`uname -i`
ISTRIMSLICE=1  # we need to set up AP mode in xs-setup-network
 
# bring in packages unique to trimslice install
yum_cmd="yum -y install "
$yum_cmd  audit avahi dhcpd hostapd xs-config

# assign an ip address to the wifi hardware
ifconfig wlan0 172.18.96.1

# stop the firewall so that wifi can be internal lan
systemctl stop firewalld.service
systemctl disable firewalld.service

# load dhcpd and attach it to the wifi adapter, 
#+ so that it can be administered headless
sed -i  "s/@@BASEDNSNAME@@/local/" /etc/dhcp/dhcpd-ts.conf.in > \
        /etc/dhcp/dhcpd.conf
sed -i  "s/@@LAN_IF@@/wlan0/" /etc/sysconfig/dhcpd.in > \
        /etc/sysconfig/dhcpd
systemctl enable dhcpd.service
systemctl start dhcpd.service

# load avahi so that the wan ip address can be discovered
cp /etc/avahi/avahi-daemon.conf.in /etc/avahi/avahi-daemon.conf

# Access Point host software
systemctl enable hostapd.service
cp -f /etc/hostapd/hostapd.conf.in /etc/hostapd/hostapd.conf
systemctl start hostapd.service

# accomodate a fixed ip for the wan interface, passed as parm $1
if [ $# -gt 0 ]; then
    if [ $# -ne 3 ]; then
        echo "3 Parameters needed for wan fixed ip: ip, gateway, dns "
        exit 1
    fi
cat << EOF > /etc/sysconfig/network-scripts/ifcfg-eth0
BOOTPROTO=static
DEVICE=eth0
ONBOOT=yes
NETMASK=255.255.224.0
IPADDR=$1
GATEWAY=$2
DNS1=$3
EOF
else
cat << EOF > /etc/sysconfig/network-scripts/ifcfg-eth0
BOOTPROTO=auto
DEVICE=eth0
ONBOOT=yes
EOF
fi

# set up the wlan0 device
cat << EOF > /etc/sysconfig/network-scripts/ifcfg-wlan0
BOOTPROTO=static
DEVICE=wlan0
ONBOOT=yes
NETMASK=255.255.224.0
IPADDR=172.18.96.1
NM_CONTROLLED=no
EOF

# xs-setup not written to protect from uninitialized variables
set +u

# chain to the reqular non trimslice XSCE setup process
source xs-setup
