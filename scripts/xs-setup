#!/bin/bash
# Initial script to convert existing OS installation into an OLPC XS.
# Configures fundamental XS items.
# Usage: xs-setup [hostname]


DESTDIR=/
CFGDIR=/usr/share/xs-config/cfg
MARKER=/.olpcxs-configured

# Parse options
opt_upgrade_only=
if ! options=$(getopt -o u -l upgrade-only -- "$@"); then
	exit 1
fi

eval set -- $options
while [ $# -gt 0 ]; do
	case $1 in
		-u|--upgrade-only) opt_upgrade_only=1 ;;
		(--) shift; break;;
		(-*) echo "$0: error - unrecognized option $1" >&2; exit 1;;
		(*) break;;
	esac
	shift
done

# The user can request that we only perform setup steps if setup had been
# previously performed by an admin. This is useful for automated upgrades
# (e.g. RPM post scripts).
if [ -n "$opt_upgrade_only" -a ! -e "$MARKER" ]; then
	echo "$0: doing nothing, XS is not active."
	exit 0
fi

# Work would be needed to get the XS components playing nice with SELinux, so
# disable it.
if selinuxenabled; then
	setenforce 0
	sed -i -e 's/^SELINUX=.*/SELINUX=disabled/' /etc/selinux/config
fi

## Prepare a .git directory so xs-commitchanged
## can store its database...
if [ ! -d /etc/.git ];then
   pushd /etc
   git init
   chmod 700 .git
   git config user.name XS
   git config user.email xs@example.com
   popd
fi

###
### CLEANUP XS 0.4 to XS 0.5
###
# Remove old configs that are unambiguously old
OLDCONFIGS="/etc/sysconfig/network-scripts/ifcfg-dummy0
            /etc/sysconfig/network-scripts/ifcfg-br0
            /etc/sysconfig/network-scripts/ifcfg-br1
            /etc/sysconfig/network-scripts/ifcfg-br2  "
for FPATH in $OLDCONFIGS; do
    if [ -e "$DESTDIR/$FPATH" ];then
       /usr/bin/xs-commitchanged --remove -m 'Remove old conffile' "$DESTDIR/$FPATH"
    fi
done
# Remove ifcfg-ethX files that refer to libertas devices
# these have been replaced with wmeshX devices
for FPATH in $DESTDIR/etc/sysconfig/network-scripts/ifcfg-eth*; do
    # Here the implicit ls has incorporated $DESTDIR
    if grep -q '^ESSID=\"school-mesh-' "$FPATH" ;then
        /usr/bin/xs-commitchanged --remove -m 'Remove old libertas conffile' "$FPATH"
    fi
done
# remove eth1:1 if it's the 'school server master address'
FPATH="$DESTDIR/etc/sysconfig/network-scripts/ifcfg-eth1:1"
if [ -e "$FPATH" ];then
    if grep -q '^IPADDR=172.18.1.1' "$FPATH" ;then
        /usr/bin/xs-commitchanged --remove -m 'Remove old conffile' "$FPATH"
    fi
fi


## Update flag for httpd cache
if [ ! -e /etc/sysconfig/xs_httpcache_on ]; then
   if chkconfig --level 3 squid ; then
      touch /etc/sysconfig/xs_httpcache_on
   fi
fi

## Prepare config files
pushd /etc
# these don't need network settings
make -B -f xs-config.make earlyset
# seed low-level network conf and domain
xs-domain-config $1
popd

echo "-y" > $DESTDIR/fsckoptions
ln -sf $CFGDIR/etc/dhcp/dhclient-exit-hooks $DESTDIR/etc/dhcp
ln -sf $CFGDIR/etc/httpd/conf.d/*.conf $DESTDIR/etc/httpd/conf.d
ln -sf $CFGDIR/etc/logrotate.d/* $DESTDIR/etc/logrotate.d
ln -sf $CFGDIR/etc/usbmount/mount.d/* $DESTDIR/etc/usbmount/mount.d

# sudo doesn't accept symlinks here
install -m 440 $CFGDIR/etc/sudoers.d/* $DESTDIR/etc/sudoers.d

# run setup scripts belonging to other packages
shopt -s nullglob
for i in /etc/sysconfig/olpc-scripts/setup.d/*; do
	[ -x $i ] && $i
done
shopt -u nullglob

# Change the network infra we use
# note that 'network' now defaults to off
chkconfig --level 345 network on
if chkconfig --level 3 NetworkManager ; then
   chkconfig --del NetworkManager
fi

# Pg - prime the DB if needed.
if [ ! -e /library/pgsql-xs/data-8.4/PG_VERSION ];then
   /etc/init.d/pgsql-xs initdb
fi

# and set it to autostart
chkconfig --add pgsql-xs
chkconfig  postgresql off

# enable no-fsck-questions
chkconfig --add no-fsck-questions

chkconfig sshd on
chkconfig ntpd on
chkconfig httpd on
chkconfig ejabberd-xs on
chkconfig crond on
chkconfig incrond on

touch $MARKER
echo "XS configured; services will activate upon reboot."
