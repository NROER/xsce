#!/bin/bash +x
# collect here all the separate setup independent changes to stock XO software
#
# usage: source this file -- for example to install a WWW server:
"""
#!/bin/bash
#examble install script
#. <diretory on path>/xs-setup-functions
#do_first
#httpd yes
#do_last
"""

set -x -e -u

DESTDIR=""
CFGDIR=/usr/share/xs-config/cfg
MARKER=/.olpcxs-configured
LOG=/var/log/xs-setup.log
POSTGRESSDIR=/library/pgsql-xs

function manpages()
{
	case "$1" in
	"yes")
        set +e
		sed -s/%_excludedocs 1/%_excludedocs 0/ /etc/rpm/macros.imgcreate
        set -e
		yum -y install man-pages man-db man | tee >> $LOG 2>&1
        ;;
	"no")
        set +e
		sed -s/%_excludedocs 0/%_excludedocs 1/ /etc/rpm/macros.imgcreate
        set -e
		yum erase  man-pages man-db man | tee >> $LOG 2>&1
        rm -rf /usr/share/man
        ;;
	esac
}

function postgresql()
{
	case "$1" in
	"yes")
        yum -y install postgresql | tee >> $LOG 2>&1
		# Pg - prime the DB if needed.
		if [ ! -e ${POSTGRESSDIR}/PG_VERSION ];then
		   #/etc/init.d/pgsql-xs initdb -- this was used before systemd
			adduser postgres
            mkdir -p $POSTGRESSDIR
			/bin/chown postgres $POSTGRESSDIR
			/bin/su  -c "/bin/initdb -D $POSTGRESSDIR -E utf8" postgres
		fi

		# and set it to autostart
		systemctl enable postgresql.service | tee >> $LOG 2>&1
		;;
	"no")
		systemctl disable postgresql.service | tee >> $LOG 2>&1
        yum erase postgresql | tee >> $LOG 2>&1
		;;
	esac
}

function httpd()
{
	case "$1" in
	"yes")
		yum -y install httpd | tee >> $LOG 2>&1
        cp -p /etc/httpd/conf/httpd-xs.conf.in /etc/httpd/conf/httpd-xs.conf
		# Choose a config depending on memory
		MEMSIZE=$(grep '^MemTotal' /proc/meminfo | grep -oP '\d+')
		CONFMEM=256m
		# Note: the sizes are rounded to a lower value
		#       as they are usually reported a tad lower than the
		#       "proper" MB value in bytes (video cards often steal RAM!).
		if [ $MEMSIZE -gt  500000 ]; then
		    CONFMEM=512m
		fi
		if [ $MEMSIZE -gt 1000000 ]; then
		    CONFMEM=1024m
		fi
		if [ $MEMSIZE -gt 2000000 ]; then
		    CONFMEM=2048m
		fi
		#update the httpd.conf file with this information
		sed  's/@@CONFMEM@@/$CONFMEM/' /etc/httpd/conf/httpd-xs.conf
		set +e; etckeeper commit -m "modified /etc/httpd/conf/httpd-xs.conf"
        set -e
        systemctl start httpd.service | tee >> $LOG 2>&1
		systemctl enable httpd.service | tee >> $LOG 2>&1
		;;
	"no")
		systemctl disable httpd.service | tee >> $LOG 2>&1
        yum erase httpd | tee >> $LOG 2>&1
		;;
	esac
}

function squid()
{
	case "$1" in
	"yes")
        yum -y install squid | tee >> $LOG 2>&1
        ## Update flag for httpd cache
        if [ ! -e /etc/sysconfig/xs_httpcache_on ]; then
           if chkconfig --level 3 squid ; then
              touch /etc/sysconfig/xs_httpcache_on
              set +e; etckeeper commit -m 'xs-setup force-create httpcache flag'; set -e
           fi
        fi
        systemctl enable squid.service | tee >> $LOG 2>&1
        #need to set up iptables to forward port 80 queries
        
        ;;
    "no")
        systemctl disable squid.service | tee >> $LOG 2>&1
        yum erase squid | tee >> $LOG 2>&1
        ;;
    esac
}

function moodle()
{
	case "$1" in
	"yes")
        yum -y install moodle | tee >> $LOG 2>&1
		systemctl enable moddle.service | tee >> $LOG 2>&1
        ;;
	"no")
		systemctl disable moddle.service | tee >> $LOG 2>&1
        yum erase moodle | tee >> $LOG 2>&1
        ;;
	esac
}

function moodle_xs()
{
	case "$1" in
	"yes")
        yum -y install moodle-xs | tee >> $LOG 2>&1
		systemctl enable moddle_xs.service | tee >> $LOG 2>&1
        ;;
	"no")
		systemctl disable moddle_xs.service | tee >> $LOG 2>&1
        yum erase moodle-xs | tee >> $LOG 2>&1
        ;;
	esac
}

function idmgr()
{
	case "$1" in
	"yes")
        yum -y install idmgr ds-backup xs-rsync  | tee >> $LOG 2>&1
		systemctl enable idmgr.service | tee >> $LOG 2>&1
        ;;
	"no")
		systemctl disable idmgr.service | tee >> $LOG 2>&1
        yum erase idmgr ds-backup xs-rsync  | tee >> $LOG 2>&1
        ;;
	esac
}

function vnc()
{
	case "$1" in
	"yes")
        yum -y install tigervnc-server | tee >> $LOG 2>&1
		systemctl enable vncserver\@.service | tee >> $LOG 2>&1
        ;;
	"no")
		systemctl disable vncserver\@.service | tee >> $LOG 2>&1
        yum erase tigervnc-server | tee >> $LOG 2>&1
        ;;
	esac
}
function avahi()
{
	case "$1" in
	"yes")
        yum -y install nss-mdns avahi avahi-tools avahi-ui | tee >> $LOG 2>&1
		systemctl enable avahi-daemon.service | tee >> $LOG 2>&1
        ;;
	"no")
		systemctl disable avahi-daemon.service | tee >> $LOG 2>&1
        #yum erase nss-mdns avahi avahi-tools avahi-ui
        ;;
	esac
}	

function named()
{
	case "$1" in
	"yes")
        yum -y install bind | tee >> $LOG 2>&1
		systemctl enable named.service | tee >> $LOG 2>&1
        ;;
	"no")
		systemctl disable named.service | tee >> $LOG 2>&1
        yum erase bind | tee >> $LOG 2>&1
        ;;
	esac
}
 
function dhcpd()
{
	case "$1" in
	"yes")
        yum -y install dhcp | tee >> $LOG 2>&1
		systemctl enable dhcpd.service | tee >> $LOG 2>&1
        ;;
	"no")
		systemctl disable dhcpd.service | tee >> $LOG 2>&1
        yum erase dhcp | tee >> $LOG 2>&1
        ;;
	esac
}

function xs-security()
{
	case "$1" in
    "yes")
        yum -y install  xs-tools olpc-bios-crypto bitfrost xs-activation | tee >> $LOG 2>&1
        ;;
    "no")
        yum erase   xs-tools olpc-bios-crypto bitfrost xs-activation | tee >> $LOG 2>&1
        ;;
    esac
}

function do_first()
{    
    #things to do the first time -- only once
    ## Prepare etckeeper database
    if [ ! -d /etc/.git ];then
        pushd /etc
        
        #init the state of the package config memory file -- currently nothing
        #       is loaded except avahi
        xs-pickpkgs.py init
        
        yum -y install etckeeper
        etckeeper init
        etckeeper commit -m "Initial checkin"
        git gc

        ###
        ### CLEANUP XS 0.4 to XS 0.5
        ###
        # Remove old configs that are unambiguously old
        OLDCONFIGS="/etc/sysconfig/network-scripts/ifcfg-dummy0
                    /etc/sysconfig/network-scripts/ifcfg-br0
                    /etc/sysconfig/network-scripts/ifcfg-br1
                    /etc/sysconfig/network-scripts/ifcfg-br2  "
        for FPATH in $OLDCONFIGS; do
            if [ -e "${DESTDIR}$FPATH" ];then
               rm -f "${DESTDIR}$FPATH"
            fi
        done
        # Remove ifcfg-ethX files that refer to libertas devices
        # these have been replaced with wmeshX devices
        for FPATH in ${DESTDIR}/etc/sysconfig/network-scripts/ifcfg-eth*; do
            # Here the implicit ls has incorporated $DESTDIR
            if grep -q '^ESSID=\"school-mesh-' "$FPATH" ;then
                rm -f "$FPATH"
            fi
        done
        # remove eth1:1 if it's the 'school server master address'
        FPATH="${DESTDIR}/etc/sysconfig/network-scripts/ifcfg-eth1:1"
        if [ -e "$FPATH" ];then
            if grep -q '^IPADDR=172.18.1.1' "$FPATH" ;then
                rm -f "$FPATH"
            fi
        fi
        
        ## Prepare config files
        CFG_TEMPLATES="rsyslog.conf motd sysctl.conf ssh/sshd_config yum.conf
        sysconfig/named sysconfig/init sysconfig/squid rssh.conf php.ini
        httpd/conf.d/proxy_ajp.conf httpd/conf.d/ssl.conf"
        
        for i in $CFG_TEMPLATES; do
            cp -p $i.in $i
        done
        
        #record the config file additions
        etckeeper commit -m 'Config files copied <file.in> to <file>'

        # Load new sysctl.conf settings
        sysctl -p

        # Work would be needed to get the XS components playing nice with SELinux, so
        # disable it.
        if selinuxenabled; then
            setenforce 0
            sed -i -e 's/^SELINUX=.*/SELINUX=disabled/' /etc/selinux/config
        fi

        echo "-y" > $DESTDIR/fsckoptions
        ln -sf $CFGDIR/etc/dhcp/dhclient-exit-hooks $DESTDIR/etc/dhcp
        ln -sf $CFGDIR/etc/httpd/conf.d/*.conf $DESTDIR/etc/httpd/conf.d
        ln -sf $CFGDIR/etc/logrotate.d/* $DESTDIR/etc/logrotate.d
        ln -sf $CFGDIR/etc/usbmount/mount.d/* $DESTDIR/etc/usbmount/mount.d

        # sudo doesn't accept symlinks here
        install -m 440 $CFGDIR/etc/sudoers.d/* $DESTDIR/etc/sudoers.d
        
        # run setup scripts belonging to other packages
        shopt -s nullglob
        for i in /etc/sysconfig/olpc-scripts/setup.d/*; do
            [ -x $i ] && $i
        done
        shopt -u nullglob

        #this needs to be turned on first so that later installs save man pages
        manpages yes
        
        #XO release 12.1.0 makes /var/log  a tempfs -- server logs should persist
        sed 's:varlog:#varlog:' /etc/fstab
        set +e;etckeeper commit -m "disabled selinux, scripts sourced"; set -e
        
        #following packages are the core set of packages installed on all xs servers
        yum -y install  xs-activity-server \
            syck rssh mtd-utils module-init-tools \
            acpid xs-release usbmount  | tee >> $LOG 2>&1
        
        
        #may remove the following for production, but very useful during debug
        yum -y install mlocate | tee >> $LOG 2>&1
        updatedb
        
        set +e; etckeeper commit -m "after installing core packages"; set -e
        
        popd
    fi
}

function do_last()
{
    set +e; etckeeper commit -m 'School Server setup changed - do_last'; set -e
    if [ ! -e $MARKER ]; then
        #internally we use /etc/.git as marker for first config run --
        #   --$ MARKER  is available externally
        touch $MARKER
        echo "XS configured; services will activate upon reboot."
    fi
}

#now source any files ending with .sh in config dir, allow pkgs to shadow these defs
for i in $CFGDIR/*.sh ; do
    if [ -r "$i" ]; then
            . "$i" >/dev/null 2>&1
            echo "shell script $i in $CFGDIR shadowed setup functions" | tee >> $LOG 2>&1
    fi
done
